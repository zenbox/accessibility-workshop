<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>Split Flap Timer</title>
        <style>
            body {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                background: #1a1a1a;
                font-family: monospace;
                gap: 20px;
                transition: background-color 1s ease;
            }

            body.timer-done {
                background-color: #2d5a27;
            }

            .display {
                display: flex;
                gap: 10px;
                padding: 20px;
                background: #222;
                border-radius: 10px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            }

            .split-flap {
                width: 100px;
                height: 150px;
                perspective: 400px;
                cursor: pointer;
                background: #333;
                border-radius: 5px;
                position: relative;
            }

            .flap {
                width: 100%;
                height: 50%;
                position: relative;
                transform-style: preserve-3d;
                transform-origin: bottom;
            }

            .flap.animating {
                animation: flip 0.25s linear;
                animation-fill-mode: forwards;
            }

            .face {
                position: absolute;
                width: 100%;
                height: 100%;
                backface-visibility: hidden;
                overflow: hidden;
                background: linear-gradient(180deg, #444 0%, #3a3a3a 100%);
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
            }

            .character {
                position: absolute;
                width: 100%;
                height: 200%;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 60px;
                color: white;
                font-family: monospace;
                font-weight: bold;
            }

            .front .character {
                top: 0;
                clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
            }

            .back {
                transform: rotateX(180deg);
                background: linear-gradient(0deg, #3a3a3a 0%, #333 100%);
            }

            .back .character {
                top: -100%;
                clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%);
            }

            .base {
                width: 100%;
                height: 50%;
                position: absolute;
                bottom: 0;
                background: linear-gradient(180deg, #3a3a3a 0%, #333 100%);
                border-bottom-left-radius: 5px;
                border-bottom-right-radius: 5px;
                overflow: hidden;
            }

            .base .character {
                height: 200%;
                top: -100%;
                clip-path: polygon(0 50%, 100% 50%, 100% 100%, 0 100%);
            }

            .next-top {
                position: absolute;
                top: 0;
                width: 100%;
                height: 50%;
                background: linear-gradient(180deg, #444 0%, #3a3a3a 100%);
                border-top-left-radius: 5px;
                border-top-right-radius: 5px;
                overflow: hidden;
                z-index: 1;
            }

            .next-top .character {
                clip-path: polygon(0 0, 100% 0, 100% 50%, 0 50%);
            }

            .divider {
                position: absolute;
                width: 100%;
                height: 2px;
                background: rgba(0, 0, 0, 0.5);
                top: 50%;
                z-index: 10;
            }

            @keyframes flip {
                0% {
                    transform: rotateX(0deg);
                    z-index: 3;
                }
                50% {
                    transform: rotateX(90deg);
                    z-index: 3;
                }
                100% {
                    transform: rotateX(180deg);
                    z-index: 3;
                }
            }

            .controls {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                justify-content: center;
                max-width: 600px;
            }

            button {
                padding: 10px 20px;
                font-size: 16px;
                background: #444;
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background 0.3s;
            }

            button:hover {
                background: #555;
            }

            button:disabled {
                background: #333;
                cursor: not-allowed;
            }

            .custom-timer {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 15px;
            }

            .custom-timer input {
                width: 80px;
                padding: 10px;
                background: #333;
                color: white;
                border: 1px solid #555;
                border-radius: 5px;
                font-size: 16px;
            }

            .custom-timer label {
                color: white;
                font-size: 16px;
            }

            .timer-status {
                margin-top: 10px;
                color: white;
                font-size: 14px;
                opacity: 0.8;
            }
        </style>
    </head>
    <body>
        <div
            class="display"
            id="displayContainer"
        ></div>

        <div class="controls">
            <button onclick="showTime()">Uhrzeit</button>
            <button onclick="startTimer(3600)">1 Std</button>
            <button onclick="startTimer(900)">15 Min</button>
            <button onclick="startTimer(600)">10 Min</button>
            <button onclick="startTimer(300)">5 Min</button>
            <button
                id="pauseResumeBtn"
                onclick="pauseResumeTimer()"
                disabled
            >
                Pause/Weiter
            </button>
            <button
                onclick="resetTimer()"
                id="resetBtn"
                disabled
            >
                Reset
            </button>
        </div>

        <div class="custom-timer">
            <label for="customMinutes">Eigene Zeit:</label>
            <input
                type="number"
                id="customMinutes"
                min="1"
                max="180"
                value="25"
                aria-label="Minuten eingeben"
            />
            <button onclick="startCustomTimer()">Start</button>
        </div>

        <div
            class="timer-status"
            id="timerStatus"
        ></div>

        <script>
            const characters = [
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9",
                ":",
                " ",
                "A",
                "B",
                "C",
                "D",
                "E",
                "F",
                "G",
                "H",
                "I",
                "J",
                "K",
                "L",
                "M",
                "N",
                "O",
                "P",
                "Q",
                "R",
                "S",
                "T",
                "U",
                "V",
                "W",
                "X",
                "Y",
                "Z",
                "!",
                "?",
            ]

            const numbers = [
                "0",
                "1",
                "2",
                "3",
                "4",
                "5",
                "6",
                "7",
                "8",
                "9",
                ":",
                " ",
            ]

            class SplitFlap {
                constructor(container) {
                    this.currentChar = characters[0]
                    this.element = this.createElements()
                    container.appendChild(this.element)
                    this.initializeElements()
                }

                createElements() {
                    const div = document.createElement("div")
                    div.className = "split-flap"
                    div.innerHTML = `
                    <div class="divider"></div>
                    <div class="next-top">
                        <div class="character">${this.currentChar}</div>
                    </div>
                    <div class="flap">
                        <div class="face front">
                            <div class="character">${this.currentChar}</div>
                        </div>
                        <div class="face back">
                            <div class="character">${this.currentChar}</div>
                        </div>
                    </div>
                    <div class="base">
                        <div class="character">${this.currentChar}</div>
                    </div>
                `
                    return div
                }

                initializeElements() {
                    this.flap = this.element.querySelector(".flap")
                    this.frontChar =
                        this.element.querySelector(".front .character")
                    this.backChar =
                        this.element.querySelector(".back .character")
                    this.baseChar =
                        this.element.querySelector(".base .character")
                    this.nextTopChar = this.element.querySelector(
                        ".next-top .character"
                    )
                }

                async flipTo(targetChar, useNumbers = false, reverse = false) {
                    if (this.currentChar === targetChar) return

                    const charSet = useNumbers ? numbers : characters

                    let currentIndex = charSet.indexOf(this.currentChar)
                    const targetIndex = charSet.indexOf(targetChar)

                    if (currentIndex === -1 || targetIndex === -1) {
                        currentIndex = characters.indexOf(this.currentChar)
                        const targetIndex = characters.indexOf(targetChar)
                        if (currentIndex === -1 || targetIndex === -1) return
                    }

                    const flipNext = async () => {
                        if (reverse) {
                            currentIndex =
                                (currentIndex - 1 + charSet.length) %
                                charSet.length
                        } else {
                            currentIndex = (currentIndex + 1) % charSet.length
                        }
                        const nextChar = charSet[currentIndex]

                        this.nextTopChar.textContent = nextChar
                        this.backChar.textContent = nextChar

                        this.flap.classList.add("animating")

                        await new Promise((resolve) => {
                            setTimeout(() => {
                                this.flap.classList.remove("animating")
                                this.frontChar.textContent = nextChar
                                this.baseChar.textContent = nextChar
                                this.currentChar = nextChar
                                resolve()
                            }, 150)
                        })

                        await new Promise((resolve) => setTimeout(resolve, 50))
                    }

                    while (charSet[currentIndex] !== targetChar) {
                        await flipNext()
                    }
                }
            }

            const displayContainer = document.getElementById("displayContainer")
            const flaps = Array.from(
                { length: 8 },
                () => new SplitFlap(displayContainer)
            )
            const pauseResumeBtn = document.getElementById("pauseResumeBtn")
            const resetBtn = document.getElementById("resetBtn")
            const timerStatus = document.getElementById("timerStatus")

            let currentMode = "time"
            let timerInterval
            let timerPaused = false
            let timerTimeLeft = 0
            let timerStartTime = 0
            let timerDuration = 0
            let timerEndTime = 0

            function setDisplay(text, mode, reverse = false) {
                const useNumbers = mode === "time" || mode === "timer"
                const chars = text.padEnd(8, " ").split("")

                flaps.forEach((flap, i) => {
                    setTimeout(() => {
                        flap.flipTo(chars[i], useNumbers, reverse)
                    }, i * 100) // Schnellere Animation (war 200ms)
                })
            }

            function resetBackground() {
                document.body.style.backgroundColor = "#1a1a1a"
                document.body.classList.remove("timer-done")
            }

            function showTimerDone() {
                document.body.style.backgroundColor = "#2d5a27"
                document.body.classList.add("timer-done")

                // Timer Abschluss-Ton abspielen
                const audio = new Audio()
                audio.src =
                    "data:audio/wav;base64,UklGRgQFAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YeAEAACAgICAgICA/f39/f39/YKCgoKCgoKB/v7+/v7+/v+Dg4ODg4OD/v7+/v7+/oGEhISEhISE/v7+/v7+/oCEhISEhISE/v7+/v7+/v+DhISEhISEgvz8/Pz8/PyBhISEhISEhIH+/v7+/v7+/4GCgoKCgoKC/v7+/v7+/v+CgoKCgoKC//7+/v7+/v7+gIKCgoKCgoL+/v7+/v7+/oODg4ODg4OB/f39/f39/YODg4ODg4OD/v7+/v7+/v+Dg4ODg4ODgfz8/Pz8/PyDg4ODg4ODg/7+/v7+/v7/g4ODg4ODg4L8/Pz8/Pz8gIWFhYWFhYWB/f39/f39/YGDg4ODg4OD/v7+/v7+/v+AgICAgICAgP7+/v7+/v7/gICAgICAgIDAwMDAwMDAGP39/f39/f39/f39/f39/Rj+/v7+/v7+/v7+/v7+/v4Y/v7+/v7+/v7+/v7+/v7+HP7+/v7+/v7+/v7+/v7+/hn+/v7+/v7+/v7+/v7+/v4Y/f39/f39/f39/f39/f39Gv7+/v7+/v7+/v7+/v7+/hn9/f39/f39/f39/f39/f0Y/v7+/v7+/v7+/v7+/v7+GP7+/v7+/v7+/v7+/v7+/hr+/v7+/v7+/v7+/v7+/v4Y/f39/f39/f39/f39/f39GP7+/v7+/v7+/v7+/v7+/hr+/v7+/v7+/v7+/v7+/v4Y/f39/f39/f39/f39/f39GP7+/v7+/v7+/v7+/v7+/hn+/v7+/v7+/v7+/v7+/v4Y/v7+/v7+/v7+/v7+/v7+HP39/f39/f39/f39/f39/Rn+/v7+/v7+/v7+/v7+/v7+/v7+/v7AwMDAwMDACgAAvgIAAL4CAAC+AgAAvgIAAL4CAAC+AgAAvgIAAL4CAAAuAAAALgAAAC4BAAAuAQAALgIAAC4CAAAuAgAALgIAAC4CAAAuAgAALgIAAC4CAAAuAgAALgIAAC4CAAAuAgAALgIAAC4CAAAuAgAALgIAAC4CAAAuAgAALgAAAC4AAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAQAAGgEAABoBAAAaAgAAGgIAABoCAAAaAgAAGgIAABoCAAAaAgAAGgIAABoCAAAKAAA="
                audio.play()
            }

            function saveTimerToLocalStorage() {
                if (currentMode === "timer") {
                    localStorage.setItem(
                        "timer",
                        JSON.stringify({
                            timeLeft: timerTimeLeft,
                            duration: timerDuration,
                            endTime: timerEndTime,
                            paused: timerPaused,
                        })
                    )
                    timerStatus.textContent = timerPaused
                        ? "Timer angehalten."
                        : "Timer läuft."
                } else {
                    localStorage.removeItem("timer")
                    timerStatus.textContent = ""
                }
            }

            function loadTimerFromLocalStorage() {
                const timerData = localStorage.getItem("timer")
                if (timerData) {
                    const timer = JSON.parse(timerData)

                    if (timer.endTime && !timer.paused) {
                        // Timer war aktiv - aktualisiere die verbleibende Zeit basierend auf Endzeit
                        const now = new Date().getTime()
                        const remainingTime = Math.floor(
                            (timer.endTime - now) / 1000
                        )

                        if (remainingTime <= 0) {
                            // Timer ist abgelaufen
                            showTimerDone()
                            updateTimerDisplay(0)
                            resetTimerControls()
                            localStorage.removeItem("timer")
                        } else {
                            // Timer fortsetzen
                            timerDuration = timer.duration
                            timerEndTime = timer.endTime
                            timerTimeLeft = remainingTime
                            timerPaused = false
                            resumeTimer()
                        }
                    } else if (timer.paused) {
                        // Timer war pausiert
                        timerTimeLeft = timer.timeLeft
                        timerDuration = timer.duration
                        timerPaused = true
                        currentMode = "timer"
                        updateTimerDisplay(timerTimeLeft)
                        enableTimerControls()
                        pauseResumeBtn.textContent = "Weiter"
                    }
                }
            }

            function showTime() {
                if (timerInterval) {
                    clearInterval(timerInterval)
                    timerInterval = null
                }

                resetBackground()
                resetTimerControls()
                currentMode = "time"
                const now = new Date()
                const hours = String(now.getHours()).padStart(2, "0")
                const minutes = String(now.getMinutes()).padStart(2, "0")
                const seconds = String(now.getSeconds()).padStart(2, "0")
                setDisplay(`${hours}:${minutes}:${seconds}`, currentMode, false)
                saveTimerToLocalStorage()
            }

            function updateTimerDisplay(timeLeft) {
                let displayText = ""
                if (timerDuration >= 3600) {
                    // Format HH:MM:SS
                    const hours = String(Math.floor(timeLeft / 3600)).padStart(
                        2,
                        "0"
                    )
                    const minutes = String(
                        Math.floor((timeLeft % 3600) / 60)
                    ).padStart(2, "0")
                    const seconds = String(timeLeft % 60).padStart(2, "0")
                    displayText = `${hours}:${minutes}:${seconds}`
                } else {
                    // Format MM:SS
                    const minutes = String(Math.floor(timeLeft / 60)).padStart(
                        2,
                        "0"
                    )
                    const seconds = String(timeLeft % 60).padStart(2, "0")
                    displayText = `   ${minutes}:${seconds}`
                }

                setDisplay(displayText, currentMode, true)
            }

            function startTimer(duration) {
                if (timerInterval) {
                    clearInterval(timerInterval)
                }

                resetBackground()
                currentMode = "timer"
                timerTimeLeft = duration
                timerDuration = duration
                timerPaused = false

                // Berechne die Endzeit
                timerEndTime = new Date().getTime() + duration * 1000

                enableTimerControls()

                updateTimerDisplay(timerTimeLeft)
                saveTimerToLocalStorage()

                timerInterval = setInterval(() => {
                    timerTimeLeft--

                    if (timerTimeLeft < 0) {
                        clearInterval(timerInterval)
                        timerInterval = null
                        showTimerDone()
                        saveTimerToLocalStorage()
                        resetTimerControls()
                        return
                    }

                    updateTimerDisplay(timerTimeLeft)
                    saveTimerToLocalStorage()
                }, 1000)
            }

            function startCustomTimer() {
                const minutes = parseInt(
                    document.getElementById("customMinutes").value
                )
                if (isNaN(minutes) || minutes < 1 || minutes > 180) {
                    alert("Bitte geben Sie eine Zahl zwischen 1 und 180 ein.")
                    return
                }

                startTimer(minutes * 60)
            }

            function pauseResumeTimer() {
                if (timerPaused) {
                    resumeTimer()
                } else {
                    pauseTimer()
                }
            }

            function pauseTimer() {
                clearInterval(timerInterval)
                timerInterval = null
                timerPaused = true

                pauseResumeBtn.textContent = "Weiter"
                saveTimerToLocalStorage()
            }

            function resumeTimer() {
                timerPaused = false
                pauseResumeBtn.textContent = "Pause"

                // Neue Endzeit berechnen
                timerEndTime = new Date().getTime() + timerTimeLeft * 1000
                saveTimerToLocalStorage()

                timerInterval = setInterval(() => {
                    timerTimeLeft--

                    if (timerTimeLeft < 0) {
                        clearInterval(timerInterval)
                        timerInterval = null
                        showTimerDone()
                        saveTimerToLocalStorage()
                        resetTimerControls()
                        return
                    }

                    updateTimerDisplay(timerTimeLeft)
                    saveTimerToLocalStorage()
                }, 1000)
            }

            function resetTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval)
                    timerInterval = null
                }

                timerTimeLeft = timerDuration
                timerPaused = true
                pauseResumeBtn.textContent = "Start"

                updateTimerDisplay(timerTimeLeft)
                saveTimerToLocalStorage()
            }

            function enableTimerControls() {
                pauseResumeBtn.disabled = false
                resetBtn.disabled = false
            }

            function resetTimerControls() {
                pauseResumeBtn.disabled = true
                resetBtn.disabled = true
                timerStatus.textContent = ""
            }

            // Initialisierung
            setInterval(() => {
                if (currentMode === "time") {
                    showTime()
                }
            }, 1000)

            // Wenn die Seite geladen wird, prüfen, ob ein Timer gespeichert ist
            document.addEventListener("DOMContentLoaded", () => {
                loadTimerFromLocalStorage()
            })

            // Wenn die Seite neu geladen oder geschlossen wird, Timer speichern
            window.addEventListener("beforeunload", () => {
                saveTimerToLocalStorage()
            })

            // Starte mit der Uhrzeit
            showTime()
        </script>
    </body>
</html>
