<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <title>jQuery UI Datepicker Beispiel</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1"
        />
        <link
            rel="stylesheet"
            href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css"
        />
        <style>
            body {
                font-family: "Barlow", system-ui, sans-serif;
                background: #f5f5f5;
                margin: 0;
                padding: 2rem;
            }

            main {
                max-width: 480px;
                margin: 0 auto;
                background: #fff;
                border-radius: 12px;
                padding: 2rem;
                box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
            }

            label {
                display: block;
                font-weight: 600;
                margin-bottom: 0.5rem;
            }

            input {
                width: 100%;
                padding: 0.75rem;
                border-radius: 10px;
                border: 2px solid #d0d6de;
                font-size: 1rem;
            }

            input:focus {
                outline: 3px solid #ffbf47;
                outline-offset: 3px;
                border-color: #005fb8;
            }

            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border: 0;
            }
        </style>
    </head>
    <body>
        <main>
            <h1 id="datepicker-title">Datum auswählen</h1>
            <p id="datepicker-description">
                Klicken Sie in das Feld oder nutzen Sie die Pfeiltasten im
                Kalender.
            </p>
            <div
                id="datepicker-keyboard-help"
                aria-live="polite"
            >
                <p>
                    <strong>Tastaturhilfe:</strong> Pfeiltasten bewegen den
                    Fokus zwischen Tagen, Bild auf/ab wechselt Monate (mit Alt
                    das Jahr), Pos1 und Ende springen zum Wochenanfang/-ende,
                    Leertaste oder Enter wählen das Datum, Escape schließt den
                    Kalender.
                </p>
            </div>

            <label for="date-input">Gewünschtes Datum</label>
            <input
                type="text"
                id="date-input"
                aria-labelledby="datepicker-title"
                aria-describedby="datepicker-description datepicker-keyboard-help"
                autocomplete="off"
                placeholder="tt.mm.jjjj"
            />
            <div
                id="datepicker-live"
                class="sr-only"
                role="status"
                aria-live="polite"
                aria-atomic="true"
            ></div>
        </main>

        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
        <script>
            $(function () {
                const liveRegion = $("#datepicker-live")
                const inputField = $("#date-input")

                const focusCalendar = (inst, message) => {
                    if (!inst) return
                    const widget = inst.dpDiv
                    setTimeout(() => {
                        const $links = widget.find("a.ui-state-default")
                        const $current = widget.find(
                            ".ui-datepicker-current-day a"
                        )
                        const target = $current.length
                            ? $current
                            : $links
                                  .filter(":not(.ui-priority-secondary)")
                                  .first()
                        $links.attr("tabindex", "-1")
                        if (target.length) {
                            target.attr("tabindex", "0").focus()
                            if (message !== false) {
                                const dayText = target.text()
                                const monthText = widget
                                    .find(".ui-datepicker-title")
                                    .text()
                                liveRegion.text(
                                    message ||
                                        `Fokus auf ${dayText}. ${monthText}.`
                                )
                            }
                        }
                    }, 0)
                }

                inputField.on("keydown", (event) => {
                    if (["ArrowDown", "Enter", " "].includes(event.key)) {
                        event.preventDefault()
                        inputField.datepicker("show")
                    }
                })

                inputField.datepicker({
                    dateFormat: "dd.mm.yy",
                    showOn: "both",
                    buttonText: "Kalender öffnen",
                    beforeShow: function (input, inst) {
                        setTimeout(() => {
                            const widget = inst.dpDiv
                            widget.attr({
                                "role": "dialog",
                                "aria-modal": "true",
                                "aria-label": "Datum auswählen",
                            })
                            widget.find("a").attr("tabindex", "-1")
                            widget.off("keydown", "a", handleCalendarKeys)
                            widget.on("keydown", "a", handleCalendarKeys)
                            focusCalendar(
                                inst,
                                "Kalender geöffnet. Pfeiltasten ändern den Tag, Bild auf oder ab den Monat, Alt + Bildtaste das Jahr."
                            )
                        }, 0)
                    },
                    onClose: function () {
                        inputField.focus()
                        liveRegion.text("Kalender geschlossen.")
                    },
                    onSelect: function (dateText) {
                        liveRegion.text(`Ausgewähltes Datum: ${dateText}.`)
                    },
                })

                function handleCalendarKeys(event) {
                    const inst = $.datepicker._curInst
                    if (!inst) return

                    const key = event.key

                    const firstDay =
                        inst.settings.firstDay != null
                            ? inst.settings.firstDay
                            : $.datepicker._defaults.firstDay

                    const getActiveDate = () => {
                        const selected = inst.input.datepicker("getDate")
                        if (selected) {
                            return new Date(selected.getTime())
                        }
                        const year =
                            inst.selectedYear ??
                            inst.drawYear ??
                            new Date().getFullYear()
                        const month =
                            inst.selectedMonth ??
                            inst.drawMonth ??
                            new Date().getMonth()
                        const day =
                            inst.selectedDay ??
                            inst.currentDay ??
                            new Date().getDate()
                        return $.datepicker._daylightSavingAdjust(
                            new Date(year, month, day)
                        )
                    }

                    const setActiveDate = (date) => {
                        inst.input.datepicker("setDate", date)
                        $.datepicker._updateDatepicker(inst)
                        const formattedLong = $.datepicker.formatDate(
                            "DD, d. MM yy",
                            date,
                            inst.settings
                        )
                        focusCalendar(inst, `Fokus auf ${formattedLong}.`)
                    }

                    const adjustBy = (modifier) => {
                        const date = getActiveDate()
                        modifier(date)
                        setActiveDate(date)
                    }

                    switch (key) {
                        case "ArrowRight":
                            event.preventDefault()
                            adjustBy((date) => date.setDate(date.getDate() + 1))
                            break
                        case "ArrowLeft":
                            event.preventDefault()
                            adjustBy((date) => date.setDate(date.getDate() - 1))
                            break
                        case "ArrowDown":
                            event.preventDefault()
                            adjustBy((date) => date.setDate(date.getDate() + 7))
                            break
                        case "ArrowUp":
                            event.preventDefault()
                            adjustBy((date) => date.setDate(date.getDate() - 7))
                            break
                        case "PageDown":
                            event.preventDefault()
                            adjustBy((date) => {
                                if (event.altKey) {
                                    date.setFullYear(date.getFullYear() + 1)
                                } else {
                                    date.setMonth(date.getMonth() + 1)
                                }
                            })
                            break
                        case "PageUp":
                            event.preventDefault()
                            adjustBy((date) => {
                                if (event.altKey) {
                                    date.setFullYear(date.getFullYear() - 1)
                                } else {
                                    date.setMonth(date.getMonth() - 1)
                                }
                            })
                            break
                        case "Home": {
                            event.preventDefault()
                            adjustBy((date) => {
                                const dayOfWeek =
                                    (date.getDay() - firstDay + 7) % 7
                                date.setDate(date.getDate() - dayOfWeek)
                            })
                            break
                        }
                        case "End": {
                            event.preventDefault()
                            adjustBy((date) => {
                                const dayOfWeek =
                                    (date.getDay() - firstDay + 7) % 7
                                date.setDate(date.getDate() + (6 - dayOfWeek))
                            })
                            break
                        }
                        case "Enter":
                        case " ":
                            event.preventDefault()
                            const selectedDate = getActiveDate()
                            inst.input.datepicker("setDate", selectedDate)
                            liveRegion.text(
                                `Ausgewähltes Datum: ${$.datepicker.formatDate(
                                    inst.settings.dateFormat ||
                                        $.datepicker._defaults.dateFormat,
                                    selectedDate,
                                    inst.settings
                                )}.`
                            )
                            $(inst.input).datepicker("hide")
                            inst.input.focus()
                            break
                        case "Escape":
                            event.preventDefault()
                            $(inst.input).datepicker("hide")
                            liveRegion.text("Kalender geschlossen.")
                            inst.input.focus()
                            break
                        default:
                            break
                    }
                }
            })
        </script>
    </body>
</html>
