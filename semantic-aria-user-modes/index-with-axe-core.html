<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0"
        />
        <title>Axe Accessibility – Vollständige Seite testen</title>
    </head>
    <body>
        <aside id="axe-core-testing-panel">
            <!-- Test Control Panel  -->
            <section
                class="test-controls"
                data-exclude="true"
                aria-label="Axe Testpanel"
            >
                <h3>Axe Tests</h3>
                <div class="row">
                    <button
                        type="button"
                        onclick="runFullTest()"
                    >
                        Vollständiger Test
                    </button>

                    <button
                        type="button"
                        onclick="runWCAGTest()"
                    >
                        WCAG 2.1 AA
                    </button>
                </div>
                <div class="row">
                    <!-- - - - - - -->
                    <button
                        type="button"
                        onclick="runTargetSizeTests()"
                    >
                        Target Size testen
                    </button>
                    <!-- - - - - - -->
                    <button
                        type="button"
                        onclick="runColorContrastTests()"
                    >
                        Farbkontraste testen
                    </button>
                    <!-- - - - - - -->
                    <!-- <button
                        type="button"
                        onclick="runTableTests()"
                    >
                        Tabellen testen
                    </button> -->
                    <!-- - - - - - -->
                </div>
                <div class="row">
                    <button
                        type="button"
                        onclick="clearResults()"
                    >
                        Ergebnisse löschen
                    </button>
                </div>
                <div
                    class="row"
                    style="align-items: center"
                >
                    <label
                        ><input
                            type="checkbox"
                            id="highlightElements"
                            checked
                        />
                        Elemente hervorheben</label
                    >
                </div>
                <fieldset
                    style="
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        padding: 8px;
                        border-radius: 6px;
                    "
                >
                    <legend style="padding: 0 6px">Scope</legend>
                    <label
                        ><input
                            style="margin: 1rem"
                            data-exclude="true"
                            type="radio"
                            name="scope"
                            value="document"
                            checked
                        />
                        Ganze Seite</label
                    >
                    <label
                        ><input
                            style="margin: 1rem"
                            data-exclude="true"
                            type="radio"
                            name="scope"
                            value="main"
                        />
                        Nur Hauptinhalt</label
                    >
                </fieldset>
                <small style="opacity: 0.85; display: block; margin-top: 6px">
                    Shortcuts: Ctrl+T (Quick) • Ctrl+Shift+T (Full) • Ctrl+L (8
                    Tests) • Ctrl+R (Clear)<br />
                    <a
                        style="color: white"
                        href="https://github.com/dequelabs/axe-core"
                        >>> Axe Core on Github</a
                    >
                </small>
            </section>

            <!-- Testergebnisse -->
            <section
                id="results"
                class="results-panel"
                data-exclude="true"
                aria-labelledby="ergebnisse-heading"
                hidden
            >
                <h2 id="ergebnisse-heading">Test-Ergebnisse</h2>
                <div
                    id="status-bar"
                    class="status-bar"
                    role="status"
                    aria-live="polite"
                ></div>
                <div id="violations-list"></div>
            </section>

            <!-- Axe Core Styles -->
            <style>
                #axe-core-testing-panel {
                    font-family: Arial, sans-serif;

                    * {
                        box-sizing: border-box;
                    }

                    /* Test-Panel (von Tests ausgeschlossen) */
                    .test-controls {
                        position: fixed;
                        inset: auto auto 16px 16px;
                        width: 320px;
                        max-width: 90vw;
                        background: #2c3e50;
                        color: #fff;
                        padding: 16px;
                        border-radius: 8px;
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
                        z-index: 1001;
                    }
                    .test-controls h3 {
                        margin: 0 0 8px;
                    }
                    .test-controls .row {
                        display: flex;
                        gap: 8px;
                        margin: 6px 0;
                    }
                    .test-controls button {
                        background: hsl(210, 50%, 35%);
                        color: #fff;
                        border: none;
                        border-radius: 6px;
                        padding: 8px 12px;
                        cursor: pointer;
                        flex: 1;
                    }
                    .test-controls button:hover {
                        background: #2980b9;
                    }
                    .test-controls label {
                        font-size: 0.9rem;
                        display: flex;
                        gap: 0.5rem;
                        align-items: center;
                    }

                    /* Ergebnis-Panel (von Tests ausgeschlossen) */
                    .results-panel {
                        margin: 24px 0;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid #17a2b8;
                    }
                    .status-bar {
                        padding: 10px;
                        text-align: center;
                        font-weight: bold;
                        border-radius: 6px;
                        margin-bottom: 15px;
                    }
                    .status-bar.success {
                        background: #d4edda;
                        color: #155724;
                        border: 1px solid #c3e6cb;
                    }
                    .status-bar.error {
                        background: #f8d7da;
                        color: #721c24;
                        border: 1px solid #f5c6cb;
                    }

                    /* Violation Cards */
                    .violation-item {
                        background: #fff;
                        margin: 10px 0;
                        padding: 15px;
                        border-radius: 6px;
                        border-left: 4px solid #dc3545;
                    }
                    .violation-item.minor {
                        border-left-color: #ffc107;
                    }
                    .violation-item.moderate {
                        border-left-color: #fd7e14;
                    }
                    .violation-item.serious {
                        border-left-color: #dc3545;
                    }
                    .violation-item.critical {
                        border-left-color: #6f42c1;
                    }
                    .violation-header {
                        font-weight: bold;
                        color: #2c3e50;
                        margin-bottom: 8px;
                    }
                    .violation-help {
                        color: #6c757d;
                        font-size: 14px;
                        margin-bottom: 10px;
                    }
                    .violation-nodes {
                        background: #f1f3f4;
                        padding: 10px;
                        border-radius: 6px;
                        margin-top: 10px;
                    }
                    .node-item {
                        margin: 5px 0;
                        font-family: monospace;
                        font-size: 12px;
                        background: #fff;
                        padding: 6px;
                        border-radius: 4px;
                    }
                }
            </style>

            <!-- Axe Core Script -->
            <script src="assets/lib/axe.min.js"></script>

            <script>
                /* ========== Helpers ========== */
                function waitForAxe(timeout = 10000) {
                    return new Promise((resolve, reject) => {
                        const t0 = Date.now()
                        ;(function check() {
                            if (window.axe && typeof axe.run === "function")
                                return resolve()
                            if (Date.now() - t0 > timeout)
                                return reject(
                                    new Error("axe-core nicht geladen")
                                )
                            requestAnimationFrame(check)
                        })()
                    })
                }

                const $ = (sel, root = document) => root.querySelector(sel)
                const $all = (sel, root = document) =>
                    Array.from(root.querySelectorAll(sel))

                function showPanel() {
                    $("#results").hidden = false
                }

                function showLoading() {
                    showPanel()
                    const bar = $("#status-bar")
                    bar.className = "status-bar"
                    bar.textContent = "🔄 Tests werden ausgeführt..."
                }

                function showError(msg) {
                    showPanel()
                    const bar = $("#status-bar")
                    bar.className = "status-bar error"
                    bar.textContent = "🔥 " + msg
                }

                function escapeHtml(text) {
                    const div = document.createElement("div")
                    div.textContent = String(text ?? "")
                    return div.innerHTML
                }

                function scopeSelector() {
                    const val = document.querySelector(
                        'input[name="scope"]:checked'
                    ).value
                    return val === "main" ? "main" : document // 'document' == ganze Seite
                }

                /* ========== Rendering ========== */
                function createViolationElement(violation) {
                    const div = document.createElement("div")
                    div.className = `violation-item ${violation.impact || ""}`
                    div.innerHTML = `
        <div class="violation-header">${escapeHtml(violation.id)} ${(
                        violation.impact || ""
                    ).toUpperCase()}</div>
        <div class="violation-help">
          ${escapeHtml(violation.help)}
          <a href="${
              violation.helpUrl
          }" target="_blank" style="margin-left:10px;">📖 Mehr Info</a>
        </div>
        <div class="violation-nodes">
          <strong>Betroffene Elemente (${violation.nodes.length}):</strong>
          ${violation.nodes
              .map(
                  (node) => `
            <div class="node-item">
              <strong>Selector:</strong> ${escapeHtml(
                  (node.target || []).join(", ")
              )}<br>
              <strong>HTML:</strong> ${escapeHtml(node.html)}<br>
              <strong>Problem:</strong> ${escapeHtml(node.failureSummary)}
            </div>
          `
              )
              .join("")}
        </div>`
                    return div
                }

                function displayResults(results) {
                    showPanel()
                    const bar = $("#status-bar")
                    const list = $("#violations-list")
                    const n = results.violations.length

                    bar.className =
                        n === 0 ? "status-bar success" : "status-bar error"
                    bar.textContent =
                        n === 0
                            ? "✅ Keine Accessibility-Violations gefunden!"
                            : `❌ ${n} Accessibility-Violation(s) gefunden`
                    list.innerHTML = ""
                    results.violations.forEach((v) =>
                        list.appendChild(createViolationElement(v))
                    )

                    console.group("🔍 Axe Ergebnis")
                    console.log("Violations:", n)
                    console.log("Passes:", results.passes.length)
                    console.log("Incomplete:", results.incomplete.length)
                    console.log("Inapplicable:", results.inapplicable.length)
                    if (n > 0) {
                        console.group("Details:")
                        results.violations.forEach((v) =>
                            console.log(
                                `${v.id} (${v.impact}): ${v.nodes.length} nodes`
                            )
                        )
                        console.groupEnd()
                    }
                    console.groupEnd()
                }

                /* ========== Highlights ========== */
                function clearHighlights() {
                    $all(".highlight-violation").forEach((el) => {
                        el.classList.remove("highlight-violation")
                        el.removeAttribute("data-violation-info")
                    })
                }

                function highlightViolations(violations) {
                    clearHighlights()
                    if (!$("#highlightElements").checked) return

                    violations.forEach((v) => {
                        ;(v.nodes || []).forEach((node) => {
                            ;(node.target || []).forEach((sel) => {
                                try {
                                    document
                                        .querySelectorAll(sel)
                                        .forEach((el) => {
                                            if (
                                                !el.closest(
                                                    '[data-exclude="true"]'
                                                )
                                            ) {
                                                el.classList.add(
                                                    "highlight-violation"
                                                )
                                                el.setAttribute(
                                                    "data-violation-info",
                                                    `${v.id} (${v.impact})`
                                                )
                                            }
                                        })
                                } catch (e) {
                                    console.warn(
                                        "Highlight-Fehler für Selector:",
                                        sel
                                    )
                                }
                            })
                        })
                    })
                }

                /* ========== Scans ========== */
                async function runFullTest() {
                    showLoading()
                    try {
                        const target = scopeSelector()
                        const results = await axe.run(target, {
                            exclude: [
                                '[data-exclude="true"]',
                                ".test-controls",
                                "#results",
                            ],
                        })
                        displayResults(results)
                        highlightViolations(results.violations)
                    } catch (err) {
                        showError("Fehler beim Test: " + err.message)
                    }
                }

                async function runQuickTest() {
                    showLoading()
                    try {
                        const target = scopeSelector()
                        const results = await axe.run(target, {
                            tags: ["wcag2a"],
                            exclude: [
                                '[data-exclude="true"]',
                                ".test-controls",
                                "#results",
                            ],
                            timeout: 5000,
                        })
                        displayResults(results)
                        highlightViolations(results.violations)
                    } catch (err) {
                        showError("Fehler beim Quick Test: " + err.message)
                    }
                }

                async function runWCAGTest() {
                    showLoading()
                    try {
                        const target = scopeSelector()
                        const results = await axe.run(target, {
                            tags: ["wcag2a", "wcag2aa", "wcag21aa"],
                            exclude: [
                                '[data-exclude="true"]',
                                ".test-controls",
                                "#results",
                            ],
                            timeout: 10000,
                        })
                        displayResults(results)
                        highlightViolations(results.violations)
                    } catch (err) {
                        showError("Fehler beim WCAG Test: " + err.message)
                    }
                }

                /**
                 * Run Target Size Tests
                 *
                 * hier testen wir wir für alle Beispiele
                 * die Regel mit den 24px ...
                 */
                async function runTargetSizeTests() {
                    // show indicator
                    showLoading()

                    // Test execution
                    try {
                        // get the testing scope
                        const target = scopeSelector()

                        // run only the target-size rule
                        const results = await axe.run(target, {
                            runOnly: { type: "rule", values: ["target-size"] },
                            exclude: [
                                '[data-exclude="true"]',
                                ".test-controls",
                                "#results",
                            ],
                            timeout: 6000, // 6 seconds, must be enough
                        })

                        // show results in an aside panel
                        displayResults(results)

                        // highlight the violations in the document
                        highlightViolations(results.violations)
                    } catch (err) {
                        showError(
                            "Fehler beim Target Size Test: " + err.message
                        )
                    }
                }

                async function runColorContrastTests() {
                    // show indicator
                    showLoading()

                    // Test execution
                    try {
                        // get the testing scope
                        const target = scopeSelector()

                        // run only the target-size rule
                        const results = await axe.run(target, {
                            runOnly: {
                                type: "rule",
                                values: ["color-contrast"],
                            },
                            exclude: [
                                '[data-exclude="true"]',
                                ".test-controls",
                                "#results",
                            ],
                            timeout: 6000, // 6 seconds, must be enough
                        })

                        // show results in an aside panel
                        displayResults(results)

                        // highlight the violations in the document
                        highlightViolations(results.violations)
                    } catch (err) {
                        showError(
                            "Fehler beim Colour Contrast Test: " + err.message
                        )
                    }
                }

                async function runTableTests() {
                    // show indicator
                    showLoading()

                    // Test execution
                    try {
                        // get the testing scope
                        const target = scopeSelector()

                        // run only the target-size rule
                        const results = await axe.run(target, {
                            runOnly: {
                                type: "rule",
                                values: [
                                    "td-headers-attr",
                                    "th-has-data-cells",
                                    "empty-table-header",
                                    "table-fake-caption",
                                    "table-duplicate-name",
                                ],
                            },
                            exclude: [
                                '[data-exclude="true"]',
                                ".test-controls",
                                "#results",
                            ],
                            timeout: 6000, // 6 seconds, must be enough
                        })

                        // show results in an aside panel
                        displayResults(results)

                        // highlight the violations in the document
                        highlightViolations(results.violations)
                    } catch (err) {
                        showError("Fehler beim Table Test: " + err.message)
                    }
                }

                async function runListOfTests() {
                    showLoading()
                    const bar = $("#status-bar")
                    const allViolations = []
                    const tests = [
                        {
                            name: "🖼️ Bilder & Alt-Text",
                            rules: ["image-alt", "svg-img-alt", "area-alt"],
                        },
                        // {name:'📝 Formulare & Labels', rules:['label','form-field-multiple-labels','duplicate-id']},
                        // {name:'🔘 Buttons & Links', rules:['button-name','link-name']},
                        // {name:'🎨 Farbkontrast', rules:['color-contrast']},
                        // {name:'📋 Heading-Struktur', rules:['heading-order','empty-heading','page-has-heading-one']},
                        // {name:'⌨️ Keyboard & Focus', rules:['tabindex','focusable-content']},
                        // {name:'📊 Tabellen', rules:['table-fake-caption','td-headers-attr','th-has-data-cells']},
                        // {name:'🏗️ ARIA & Semantik', rules:['aria-valid-attr','aria-valid-attr-value','aria-roles']}
                    ]

                    try {
                        const target = scopeSelector()
                        for (let i = 0; i < tests.length; i++) {
                            const t = tests[i]
                            bar.className = "status-bar"
                            bar.textContent = `🔄 Test ${i + 1}/${
                                tests.length
                            }: ${t.name}`
                            try {
                                const res = await axe.run(target, {
                                    runOnly: { type: "rule", values: t.rules },
                                    exclude: [
                                        '[data-exclude="true"]',
                                        ".test-controls",
                                        "#results",
                                    ],
                                    timeout: 6000,
                                })
                                allViolations.push(...res.violations)
                            } catch (err) {
                                console.warn(
                                    "Einzeltest-Fehler:",
                                    t.name,
                                    err.message
                                )
                            }
                        }
                        const results = {
                            violations: allViolations,
                            passes: [],
                            incomplete: [],
                            inapplicable: [],
                        }
                        displayResults(results)
                        highlightViolations(allViolations)
                    } catch (err) {
                        showError("Fehler bei Einzeltests: " + err.message)
                    }
                }

                /* ========== Utilities ========== */
                function clearResults() {
                    $("#results").hidden = true
                    $("#violations-list").innerHTML = ""
                    clearHighlights()
                }

                function doSomething() {
                    alert(
                        "Diese Funktion sollte über einen echten Button zugänglich sein!"
                    )
                }

                /* ========== Shortcuts & Init ========== */
                document.addEventListener("keydown", (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key === "t") {
                            e.preventDefault()
                            runQuickTest()
                        }
                        if (e.key === "T") {
                            e.preventDefault()
                            runFullTest()
                        }
                        if (e.key === "l") {
                            e.preventDefault()
                            runListOfTests()
                        }
                        if (e.key === "r") {
                            e.preventDefault()
                            clearResults()
                        }
                    }
                })

                window.addEventListener("load", async () => {
                    try {
                        await waitForAxe()
                        console.log(
                            "✅ axe-core geladen. Scope umschaltbar (Ganze Seite / Main)."
                        )
                    } catch (err) {
                        showError(err.message)
                    }
                })
            </script>
        </aside>
    </body>
</html>
